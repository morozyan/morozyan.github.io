<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="user-scalable=no" />
    <title>Spanish Numbers Recognition Trainer</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
    <style>
        html, body {
            height: 100%;
            width: 100%;
            background-color: #9D7A7C;
        }

        @media (orientation: portrait) {
            #container {
                height: 50%;
                width: 100%;
                display: grid;
                grid-template-columns: repeat(1, 1fr);
                gap: 10px;
            }

            #header {
                height: 100%;
                width: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 4vh;
            }

            #play, #next,
            #userValue, #verify,
            #maxValuePrefix, #maxValue {
                height: 100%;
                width: 49%;
                margin-left: 0.25%;
                padding: 0;
                border: 0;
                font-size: 4vh;
                line-height: 0;
            }

            #maxValuePrefix {
                display: inline-block;
                text-align: right;
            }

            #result, #successfulAttempts {
                height: 100%;
                width: 49%;
                font-size: xxx-large;
            }

            #resultRow, #result, #successfulAttempts {
                display: flex;
            }

            #successfulAttempts {
                justify-content: right;
                align-items: center;
            }

            #result {
                justify-content: left;
                align-items: center;
            }

            #userValue {
                text-align: center;
                -moz-appearance: textfield;
            }

            #maxValue {
                -moz-appearance: none;
            }
        }
    </style>
    <div id="container">

        <div class="row">
            <span id="header">Numbers in MX Spanish</span>
        </div>

        <div class="row">
            <span id="maxValuePrefix">from 0 to&nbsp;</span>
            <select id="maxValue">
                <option value="10">10</option>
                <option value="100">100</option>
                <option value="1000">1000</option>
                <option value="10000">10000</option>
            </select>
        </div>

        <div class="row">
            <button id="play">
                Play again 🔊
            </button>
            <button id="next">
                Play next 🔊
            </button>
        </div>

        <div class="row">
            <input id="userValue" type="number" min="0" step="1" max="10000" placeholder="type here" pattern="[0-9]+" inputmode="numeric"/>
            <button id="verify">Check</button>
        </div>

        <div class="row" id="resultRow">
            <span id="result"></span>
            <span id="successfulAttempts"></span>
        </div>

    </div>

    <script>
        let url = "https://mx-num-poc.azurewebsites.net/api/Generator";

        let nextBtn = document.querySelector("#next");
        let verifyBtn = document.querySelector("#verify");
        let playBtn = document.querySelector("#play");

        let resultBox = document.querySelector("#result");
        let successfulAttemptsBox = document.querySelector("#successfulAttempts");

        let userValueInput = document.querySelector("#userValue");

        let marks = {
            correctAnswer: "✔️",
            wrongAnswer: "❌"
        };

        let state = {
            allAttempts: 0,
            successfulAttempts: 0,
            wasAnswered: false,
            guessedNumber: null
        };


        let audio = new Audio();

        let cleanResult = () => {
            resultBox.innerHTML = '';
        };

        let guessNumber = () => {

            let numberUrl = new URL(url);
            let maxValue = document.querySelector("#maxValue").value;

            numberUrl.searchParams.set('maxValue', maxValue);
            let tempGuessedNumber = null;

            cleanResult();
            userValueInput.value = '';
            nextBtn.setAttribute("disabled", "disabled");
            playBtn.setAttribute("disabled", "disabled");
            verifyBtn.removeAttribute("disabled");

            fetch(numberUrl, {
                method: 'POST'
            })
                .then(response => {
                    if (response.ok) {
                        tempGuessedNumber = response.headers.get("guessed_number");
                        return response.arrayBuffer();
                    }
                    throw new Error();
                })
                .then(arrayBuffer => {
                    audio.src = URL.createObjectURL(new Blob([arrayBuffer]));

                    state.guessedNumber = tempGuessedNumber;
                    state.wasAnswered = false;

                    audio.play();

                    state.allAttempts++;
                    updateState();
                })
                .then(() => {
                    nextBtn.removeAttribute("disabled");
                    playBtn.removeAttribute("disabled");
                })
                .catch((error) => {
                    alert("Something went wrong");
                });;

        };

        nextBtn.addEventListener('click', guessNumber);

        let repeatNumber = () => {
            if (audio.src != '') {
                audio.play();
                if (state.wasAnswered == false) {
                    cleanResult();
                }
            } else {
                guessNumber()
            }
        }

        playBtn.addEventListener('click', repeatNumber);

        let checkNumber = () => {

            let userValue = userValueInput.value;
            if (userValue == "") {
                return;
            }

            if (userValue == state.guessedNumber) {

                if (state.wasAnswered == false) {
                    state.successfulAttempts++;
                }
                state.wasAnswered = true;

                resultBox.innerHTML = marks.correctAnswer;

                verifyBtn.setAttribute("disabled", "disabled");

                updateState();
            } else {
                resultBox.innerHTML = marks.wrongAnswer;
            }
        };

        verifyBtn.addEventListener('click', checkNumber);

        console.log("test");

        let updateState = () => {
            successfulAttemptsBox.innerHTML
                = `${marks.correctAnswer}${state.successfulAttempts}/${state.allAttempts}`;
        }

        let setKeyHandlers = () => {
            let guessNumberKeys = ["*", "d"];

            let checkNumberKeys = ["Enter", "s"];

            let repeatNumberKeys = ["/", "a"];

            document.addEventListener("keyup", function (event) {
                if (guessNumberKeys.includes(event.key)) {
                    guessNumber();
                } else if (checkNumberKeys.includes(event.key)) {
                    checkNumber();
                } else if (repeatNumberKeys.includes(event.key)) {
                    repeatNumber();
                }
            });
            userValueInput.focus();
        }

        setKeyHandlers();
        updateState();
    </script>
</body>
</html>
